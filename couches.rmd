---
title: "Coasting on Couches"
output: pdf_document #html_document
# runtime: shiny
author: Akshay *Regulagedda*, Kevin *Tan*, Wan Ling *Loh*, Zach *Zhang*, Xin Ying *Goh*
editor_options: 
  chunk_output_type: inline
---
# 0. Introduction
This document lists the exploratory data analysis, model build and analysis for *Coasting on Couches*, the term project for MGT 6203 Spring semester. Whilst the project document and slides/ presentation list a more human-readable version, this document combines some exposition with a lot of code to generate graphs, to put it simply.


## 0.1 Library Setup
The document will be shared as a Shiny app and in the raw RMd format. 

Please run the following chunk to ensure all the necessary libraries are installed/ present should you wish to execute the chunks at your end. (Idea taken from [this blogpost](https://vbaliga.github.io/verify-that-r-packages-are-installed-and-loaded/))

```{r include=FALSE}
packages<- c("dplyr", "stringr", "readr", "stargazer", "knitr", "DataExplorer", "ggplot2", "ggExtra", "psych", "PerformanceAnalytics", "corrplot", "mice", 
             "plotly", "geojsonio")#, "rjson") #add new libraries here

package.check <- lapply(
  packages,
  FUN = function(x)
  {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)
```
@XY, ZZ, WL: Please include this citation in our report: 
 Hlavac, Marek (2022). stargazer: Well-Formatted Regression and Summary Statistics Tables.
 R package version 5.2.3. https://CRAN.R-project.org/package=stargazer 
 
# 1. Loading Data

We had downloaded data from [InsideAirbnb.com](http://insideairbnb.com/get-the-data) to the data folder. This will be available on our [GitHub repo](https://github.com/metamutator/crispy-octo-waffle). 

The data is in four parts (each city has all five elements):
1. ``listing``: These are the actual Airbnb listings. The columns are defined [here](https://docs.google.com/spreadsheets/d/1iWCNJcSutYqpULSQHlNyGInUvHg2BoUGoNRIGa6Szc4/edit#gid=982310896). This is set of 74 variables pertaining to a specific listing.
2. ``review``: List of reviews per row in the ``listing`` table.
3. ``calendar``: Price of a particular listing on a particular date, along with min-max nights for hire
4. ``neighbourhoods``: List of neighbourhoods screened in the city
5. ``map``: GeoJson shapefile showing district boundaries.

## 1.1 Raw

We will read all the data into dataset variables. 
```{r echo=TRUE, message=TRUE, warning=TRUE}
#Singapore
listing.sin <- read.csv("./data/SIN_listings.csv")
reviews.sin <- read.csv("./data/SIN_reviews.csv")
calendar.sin <- read.csv("./data/SIN_calendar.csv")
neighbourhoods.sin <- read.csv("./data/SIN_neighbourhoods.csv")
map.sin <- geojson_read("./data/SIN_neighbourhoods.geojson")

#Taipei
listing.tpe <- read.csv("./data/TPE_listings.csv")
reviews.tpe <- read.csv("./data/TPE_reviews.csv")
calendar.tpe <- read.csv("./data/TPE_calendar.csv")
neighbourhoods.tpe <- read.csv("./data/TPE_neighbourhoods.csv")
map.tpe <- geojson_read("./data/TPE_neighbourhoods.geojson")

#Tokyo
listing.nrt <- read.csv("./data/NRT_listings.csv")
reviews.nrt <- read.csv("./data/NRT_reviews.csv")
calendar.nrt <- read.csv("./data/NRT_calendar.csv")
neighbourhoods.nrt <- read.csv("./data/NRT_neighbourhoods.csv")
map.nrt <- geojson_read("./data/NRT_neighbourhoods.geojson")

#Hong Kong
listing.hkg <- read.csv("./data/HKG_listings.csv")
reviews.hkg <- read.csv("./data/HKG_reviews.csv")
calendar.hkg <- read.csv("./data/HKG_calendar.csv")
neighbourhoods.hkg <- read.csv("./data/HKG_neighbourhoods.csv")
map.hkg <- geojson_read("./data/HKG_neighbourhoods.geojson")
```

## 1.2 Initial Data Analysis

### 1.2.0 Number of Listings
We first see the number of listings per city.
```{r}
cities  <- c("Singapore", "Tokyo", "Taipei", "Hong Kong")
no_of_listings <- c(nrow(listing.sin), nrow(listing.nrt), nrow(listing.tpe), nrow(listing.hkg))
no_of_listings.fig <- plot_ly(
  x = cities,
  y = no_of_listings,
  type = "bar", 
  text = no_of_listings
)
no_of_listings.fig <- no_of_listings.fig %>% layout(title ="No of Listings Per City", yaxis = list(title="No of Listings"))
no_of_listings.fig
```

Clearly, Tokyo has the largest number of listings followed by Hong Kong, Taipei and then Singapore. 

### 1.2.1 Listings by Neighbourhood - Choropleth Maps

Let us also consider heatmaps of where the listings are in each city by neighbourhood. Admittedly, the InsideAirbnb website has a map for each city (here's one for [Taipei](http://insideairbnb.com/taipei)), but this does not show by district. At a later stage, this can be enhanced to see by variable or time-series.

```{r}
generate_choropleth_by_city <- function (listing, map, city_name)
{
  listings_by_neighbourhood <- listing %>%
                                count(neighbourhood_cleansed) 
  # neighbourhoods_zero <- neighbourhoods %>%
  #                       filter(!neighbourhood %in% listings_by_neighbourhood$neighbourhood) %>%
  #                       mutate(n = 0) %>%
  #                       select(neighbourhood, n)
  # listings_by_neighbourhood <- union(listings_by_neighbourhood, neighbourhoods_zero)
  # print(listings_by_neighbourhood)
  g <- list (
    fitbounds = "locations",
    visible = FALSE
  )
  fig <- plot_ly()
  fig <- fig %>% add_trace(
    type="choropleth",
    geojson=map,
    locations=listings_by_neighbourhood$neighbourhood_cleansed,
    z=listings_by_neighbourhood$n,
    colorscale="jet",
    featureidkey="properties.neighbourhood"
  )
  
  fig <- fig %>% layout(
    geo = g
  )
  fig <- fig %>% colorbar(title = "No of listings")
  fig <- fig %>% layout(
    title = paste0("Listings by Neighbourhood - ", city_name)
  )
  fig
}

generate_choropleth_by_city(listing.sin, map.sin, "Singapore")
generate_choropleth_by_city(listing.nrt, map.nrt, "Tokyo")
generate_choropleth_by_city(listing.hkg, map.hkg, "Hong Kong")
generate_choropleth_by_city(listing.tpe, map.tpe, "Taipei")
```

### 1.2.2 Listings by Neighbourhood - Bar Charts

We could also see this as barcharts.
```{r}
bar_charts_by_neighbourhood <- function (listing, city_name, neighbourhoods)
{
  listings_by_neighbourhood <- listing %>%
                                count(neighbourhood_cleansed) %>%
                                # rename(neighbourhood = neighbourhood_cleansed)
                                arrange(desc(n))
  # print(listings_by_neighbourhood)
  neighbourhoods_zero <- neighbourhoods %>%
                        filter(!neighbourhood %in% listings_by_neighbourhood$neighbourhood_cleansed) %>%
                        rename(neighbourhood_cleansed = neighbourhood) %>%
                        mutate(n = 0) %>%
                        select(neighbourhood_cleansed, n)
  print(neighbourhoods_zero)
  listings_by_neighbourhood <- union(listings_by_neighbourhood, neighbourhoods_zero)
  # print(listings_by_neighbourhood)
  fig<- plot_ly(y=listings_by_neighbourhood$neighbourhood_cleansed, x=listings_by_neighbourhood$n, type="bar", orientation="h") %>%
        layout(yaxis=list(categoryorder = "total ascending"), title=paste("Listings per neighbourhood in", city_name))
  fig
}

bar_charts_by_neighbourhood(listing.sin, "Singapore", neighbourhoods.sin)
bar_charts_by_neighbourhood(listing.nrt, "Tokyo", neighbourhoods.nrt)
bar_charts_by_neighbourhood(listing.hkg, "Hong Kong", neighbourhoods.hkg)
bar_charts_by_neighbourhood(listing.tpe, "Taipei", neighbourhoods.tpe)
```

The majority of listings in Taipei, Tokyo and Hong Kong are in tourist-heavy districts. While the top district in Tokyo is Shinjuku, that in Hong Kong is  Yau Tsim Mong, Kowloon's core urban area formed by the combination of Yau Ma Tei, Tsim Sha Tsui and Mong Kok. Taipei's top district is Zhongzheng district ("中正區"), consisting of historic sites and cultural performances.

In contrast to the other three cities, the top district in Singapore is the high-end residential condo district, Kallang. Not tourist heavy, but close to the downtown's many attractions. The tourist-heavy Geylang, Downtown Core and Outram districts appear after Kallang.

Taipei and Hong Kong have listings in all districts. But 11 districts in Singapore (mostly military installations or the airport) and 16 districts in Tokyo do not have any listings. 

### 1.2.3 Amenities

There's a column called amenities in the dataset that appears to list all the self-reported amenities in the listing as a single comma-separated list. Let's try to see this further. 

For instance, here's the longest list of amenities among Singapore listings.
```{r echo=TRUE, message=TRUE, warning=TRUE, paged.print=TRUE}
listing_amenities.sin <- listing.sin %>%
                      mutate(amenities = str_replace(amenities, "\\[","")) %>%
                      mutate(amenities = str_replace(amenities, "\\]","")) %>%
                      mutate(amenities = str_replace_all(amenities, "\"","")) %>%
                      mutate(amenities = str_replace_all(amenities, ", " ,",")) %>%
                      mutate(amenities_list = as.list(strsplit(amenities, ","))) %>%
                      mutate(no_of_am = lengths(amenities_list)) %>%
                      mutate(Wifi = as.numeric(grepl('Wifi', amenities, fixed = TRUE))) %>%
                      mutate(Shampoo = as.numeric(grepl('Shampoo', amenities, fixed = TRUE))) %>%
                      mutate(Kitchen = as.numeric(grepl('Kitchen', amenities, fixed = TRUE))) 

# listing_amenities.sin %>% select(amenities, Wifi, Shampoo, Kitchen, Patio)

max_amenities.sin <- listing_amenities.sin %>%
                      select(amenities, no_of_am) %>%
                      group_by() %>%
                     slice(which.max(no_of_am))
amenities_list_string <- as.list(strsplit(as.character(max_amenities.sin["amenities"]), ","))
amenities_list_string

#"Shampoo,Kitchen,Long term stays allowed,Washer,Smart lock,Hair dryer,Dryer,Wifi,Hot water,TV,Air conditioning,Smoke alarm,Fire extinguisher"
```

Apropos nothing, we will use the following amenities as dummy variables for price:
> "Shampoo,Kitchen,Long term stays allowed,Washer,Hair dryer,Wifi,Hot water,TV,Air conditioning"

### 1.2.4 Host Verifications

Similarly, let us also further analyse the column `host_verifications` to see if we can generate dummy variables from there as well.
```{r}
listing_host_verf.sin <- listing.sin %>%
                      mutate(host_verifications = str_replace(host_verifications, "\\[","")) %>%
                      mutate(host_verifications = str_replace(host_verifications, "\\]","")) %>%
                      mutate(host_verifications = str_replace_all(host_verifications, "\"","")) %>%
                      mutate(host_verifications = str_replace_all(host_verifications, ", " ,",")) %>%
                      mutate(host_verifications_list = as.list(strsplit(host_verifications, ","))) %>%
                      mutate(no_of_vf = lengths(host_verifications_list))

max_verf.sin <- listing_host_verf.sin %>%
                      select(host_verifications, no_of_vf) %>%
                      group_by() %>%
                     slice(which.max(no_of_vf))
host_verf_list_string <- as.list(strsplit(as.character(max_verf.sin["host_verifications"]), ","))
host_verf_list_string
```
Let's take this list to generate dummy variables.
> ['email', 'phone', 'facebook', 'reviews', 'manual_offline', 'jumio', 'offline_government_id', 'government_id', 'work_email']

Let's generalise these two bits for all cities and create dummy variables for each one of them.

```{r}

wrangle_amenities_hostvf <- function (listing)
{
  listing <- listing %>%
            mutate(amenities = str_replace(amenities, "\\[","")) %>%
            mutate(amenities = str_replace(amenities, "\\]","")) %>%
            mutate(amenities = str_replace_all(amenities, "\"","")) %>%
            mutate(amenities = str_replace_all(amenities, ", " ,",")) %>%
            mutate(amenities_list = as.list(strsplit(amenities, ","))) %>%
            mutate(no_of_am = lengths(amenities_list)) %>%
            mutate(Amenities_Wifi = as.numeric(grepl('Wifi', amenities, fixed = TRUE))) %>%
            mutate(Amenities_Shampoo = as.numeric(grepl('Shampoo', amenities, fixed = TRUE))) %>%
            mutate(Amenities_Kitchen = as.numeric(grepl('Kitchen', amenities, fixed = TRUE))) %>%
            mutate(Amenities_Long_Term = as.numeric(grepl('Long term stays', amenities, fixed = TRUE))) %>%
            mutate(Amenities_Washer = as.numeric(grepl('Washer', amenities, fixed = TRUE))) %>%
            mutate(Amenities_HairDryer = as.numeric(grepl('Hair dryer', amenities, fixed = TRUE))) %>%
            mutate(Amenities_HotWater = as.numeric(grepl('Hot water', amenities, fixed = TRUE))) %>%
            mutate(Amenities_TV = as.numeric(grepl('TV', amenities, fixed = TRUE))) %>%
            mutate(Amenities_AC = as.numeric(grepl('Air conditioning', amenities, fixed = TRUE))) %>%

            mutate(host_verifications = str_replace(host_verifications, "\\[","")) %>%
            mutate(host_verifications = str_replace(host_verifications, "\\]","")) %>%
            mutate(host_verifications = str_replace_all(host_verifications, "\"","")) %>%
            mutate(host_verifications = str_replace_all(host_verifications, ", " ,",")) %>%
            mutate(host_verifications_list = as.list(strsplit(host_verifications, ","))) %>%
            mutate(hv_email = as.numeric(grepl('email', host_verifications, fixed = TRUE))) %>%
            mutate(hv_phone = as.numeric(grepl('phone', host_verifications, fixed = TRUE))) %>%
            mutate(hv_facebook = as.numeric(grepl('facebook', host_verifications, fixed = TRUE))) %>%
            mutate(hv_reviews = as.numeric(grepl('reviews', host_verifications, fixed = TRUE))) %>%
            mutate(hv_manual_offline = as.numeric(grepl('manual_offline', host_verifications, fixed = TRUE))) %>%
            mutate(hv_manual_jumio = as.numeric(grepl('jumio', host_verifications, fixed = TRUE))) %>%
            mutate(hv_manual_off_gov = as.numeric(grepl('offline_government_id', host_verifications, fixed = TRUE))) %>%
            mutate(hv_manual_gov = as.numeric(grepl('government_id', host_verifications, fixed = TRUE))) %>%
            mutate(hv_manual_work_email = as.numeric(grepl('work_email', host_verifications, fixed = TRUE))) %>%
            mutate(no_of_vf = lengths(host_verifications_list))
}

listing.sin <- wrangle_amenities_hostvf(listing.sin)
listing.nrt <- wrangle_amenities_hostvf(listing.nrt)
listing.tpe <- wrangle_amenities_hostvf(listing.tpe)
listing.hkg <- wrangle_amenities_hostvf(listing.hkg)
```

## 1.3 Data Wrangling

### 1.3.1 Wrangling Listings
This is a function that wrangles AirBnb data into an analysable chunk. Because we will be doing the same for multiple cities, we will do a function out of this. The function is based on top of code shared in the lecture for Module 2. The obvious additions are the id column, neighbourhoods and dummy variables for amenities and host verification.
```{r}

wrangle_airbnb_dataset <- function (raw_listing_full)
{
  listing.raw <- raw_listing_full  %>% 
                select(id, price,number_of_reviews,beds,bathrooms,accommodates,reviews_per_month, property_type, room_type, review_scores_rating, neighbourhood_cleansed, host_response_time, host_response_rate, host_acceptance_rate, host_is_superhost, latitude, longitude, amenities, last_review, no_of_am, Amenities_Wifi, Amenities_Shampoo, Amenities_Kitchen, Amenities_Long_Term, Amenities_Washer, Amenities_HairDryer, Amenities_HotWater, Amenities_TV,Amenities_AC, host_verifications, hv_email,hv_phone, hv_facebook, hv_reviews, hv_manual_offline, hv_manual_jumio,hv_manual_off_gov, hv_manual_gov, hv_manual_work_email, no_of_vf) %>% 
                rename(Reviews = number_of_reviews) %>% 
                rename(Beds = beds) %>% 
                rename(Baths = bathrooms) %>% 
                rename(Capacity = accommodates) %>% 
                rename(Monthly_Reviews = reviews_per_month) %>% 
                rename(Property_Type = property_type) %>% 
                rename(Room_Type = room_type) %>% 
                rename(Price = price) %>% 
                rename(Rating = review_scores_rating) %>%
                rename(Neighbourhood = neighbourhood_cleansed) %>%
                rename(host_Superhost = host_is_superhost)


  listing.raw <-  listing.raw %>% 
                mutate(Price = str_replace(Price, "[$]", "")) %>% 
                mutate(Price = str_replace(Price, "[,]", "")) %>% 
                mutate(Price = as.numeric(Price)) %>% 
                
                mutate(host_response_rate = str_replace(host_response_rate, "[%]", "")) %>%
                mutate(host_response_rate = as.numeric(host_response_rate)/100) %>%
                mutate(host_acceptance_rate = str_replace(host_acceptance_rate, "[%]", "")) %>%
                mutate(host_acceptance_rate = as.numeric(host_acceptance_rate)/100) %>%
                mutate(host_Superhost = ifelse(host_Superhost =="f", 0, 1)) %>%
    
                mutate(host_response_rate = factor(host_response_rate, levels = c("within a few hours", "within a day", "a few days or more"))) %>%
                mutate(host_response_hours = ifelse(host_response_rate == "within a few hours"),1,0) %>%
                mutate(host_response_day = ifelse(host_response_rate == "within a day"),1,0) %>%
                mutate(host_response_few_days = ifelse(host_response_rate == "a few days or more"),1,0) %>%
                
                mutate(last_review = as.Date(last_review)) %>%
                mutate(Days_since_last_review = as.numeric(difftime(as.Date("2021-12-31"), last_review, units="days"))) %>%
    
                mutate(Room_Type = factor(Room_Type, levels = c("Shared room", "Private room", "Entire home/apt"))) %>% 
                mutate(Capacity_Sqr = Capacity * Capacity) %>% 
                mutate(Beds_Sqr = Beds * Beds) %>% 
                mutate(Baths_Sqr = Baths * Baths) %>% 
                mutate(ln_Price = log(1+Price)) %>% 
                mutate(ln_Beds = log(1+Beds)) %>%
                mutate(ln_Baths = log(1+Baths)) %>% 
                mutate(ln_Capacity = log(1+Capacity)) %>% 
                mutate(ln_Rating = log(1+Rating)) %>% 
                mutate(Shared_ind = ifelse(Room_Type == "Shared room",1,0)) %>% 
                mutate(House_ind = ifelse(Room_Type == "Entire home/apt",1,0)) %>% 
                mutate(Private_ind = ifelse(Room_Type == "Private room",1,0)) %>% 
                mutate(Capacity_x_Shared_ind = Shared_ind * Capacity) %>% 
                mutate(H_Cap = House_ind * Capacity) %>% 
                mutate(P_Cap = Private_ind * Capacity) %>% 
                mutate(ln_Capacity_x_Shared_ind = Shared_ind * ln_Capacity) %>% 
                mutate(ln_Capacity_x_House_ind = House_ind * ln_Capacity) %>% 
                mutate(ln_Capacity_x_Private_ind = Private_ind * ln_Capacity) %>%
                
                filter(!is.na(Price))

  return(listing.raw)
}

list.sin <- wrangle_airbnb_dataset(listing.sin)
list.nrt <- wrangle_airbnb_dataset(listing.nrt)
list.tpe <- wrangle_airbnb_dataset(listing.tpe)
list.hkg <- wrangle_airbnb_dataset(listing.hkg)
```

### 1.3.2 Wrangling Reviews.
There's value in understanding how many reviews a property has received in the last 12 months.  We check this by wrangling the review dataset.

```{r}
count_reviews <- function(listings, reviews, from_date, to_date)
{
  reviews_grouped <- reviews %>%
                  mutate(date = as.Date(date)) %>%
                  filter(between(date, as.Date(from_date), as.Date(to_date))) %>%
                  group_by(listing_id) %>%
                  summarise(reviews_since_2019 = n()) %>%
                  mutate(bookings_since_2019 = reviews_since_2019*2) %>%
                  rename(id = listing_id)
  listings <- left_join(listings, reviews_grouped, by="id")
  return(listings)
}
start_date = "2019-1-1"
end_date = "2021-12-31"
list.sin <-count_reviews(list.sin, reviews.sin,start_date, end_date)
list.hkg <- count_reviews(list.hkg, reviews.sin,start_date, end_date)
list.tpe <- count_reviews(list.tpe, reviews.sin,start_date, end_date)
list.nrt <- count_reviews(list.nrt, reviews.sin,start_date, end_date)

list_after_2019.sin <- list.sin %>% filter(!is.na(reviews_since_2019)) 
list_after_2019.tpe <- list.tpe %>% filter(!is.na(reviews_since_2019))
list_after_2019.nrt <- list.nrt %>% filter(!is.na(reviews_since_2019)) 
list_after_2019.hkg <- list.hkg %>% filter(!is.na(reviews_since_2019))

```

# 2. Variable Selection: Exploratory Data Analysis

We now attempt to check on variables for each city.

## 2.1 Singapore
```{r}
data_exploration <- function (listing)
{
  plot_str(listing, type="r")
  introduce(listing)
  plot_intro(listing)
  plot_missing(listing)
  plot_bar(listing)
  pca_df <- na.omit(list.sin[, c("Price", "Room_Type", "Reviews", "Beds", "Capacity", "Monthly_Reviews", "host_Superhost", "Rating","Days_since_last_review")])#, "host_response_rate", "host_response_hours", "host_acceptance_rate","host_response_day", "host_response_few_days")])
  plot_qq(pca_df)
  plot_prcomp(pca_df, variance_cap = 0.9, nrow = 2L, ncol=2L)
}
data_exploration(list.sin)
```
Taipei
```{r}
data_exploration(list.tpe)
```

Hong Kong
```{r}
data_exploration(list.hkg)
```

Tokyo
```{r}
data_exploration(list.nrt)
```

CODE DOESNT WORK BEYOND THIS
----------------

## 1.3 Outlier Detection
We will now check out outliers in our data for various parameters.

```{r}
generate_price_boxplot <- function (listing.clean, city, comparison_col = "")
{
  # png(file = "./graphs/boxplot.png")
  if (comparison_col == "")
  {
    boxplot(listing.clean$Price, data = listing.clean, ylab="Price", main=paste("Boxplot: Price for", city))
  }
  else
    boxplot(listing.clean$Price ~ listing.clean[[comparison_col]], data = listing.clean, ylab="Price", xlab=comparison_col, main=paste("Boxplot: Price vs", comparison_col, "for", city))
  # dev.off()
}

generate_price_boxplot(sin_listing.clean, "Singapore") #, sin_listing.clean$)
generate_price_boxplot(sin_listing.clean, "Singapore", "Room_Type") #, sin_listing.clean$)
generate_price_boxplot(sin_listing.clean, "Singapore", "Property_Type") #, sin_listing.clean$)
generate_price_boxplot(sin_listing.clean, "Singapore", "Capacity") #, sin_listing.clean$)
generate_price_boxplot(sin_listing.clean, "Singapore", "Beds") #, sin_listing.clean$)
generate_price_boxplot(sin_listing.clean, "Singapore", "Region") #, sin_listing.clean$)
generate_price_boxplot(sin_listing.clean, "Singapore", "Neighbourhood") #, sin_listing.clean$)
```
That was a visual analysis of outliers. Clearly, there are a few offerings that are very highly priced. Let's look at them in a bit more depth, especially those units with rental prices above $5000. 

```{r}
filter(sin_listing.clean, Price > 5000)
```

The listing for Southern Islands was curious enough for us to want to look it up on a map. 

![Southern Islands](./images/jurassicpark.png)

The given coordinates point to a location in Universal Studios Singapore, specifically the Jurassic Park Rapids Adventure ride. Now the price to USS is indeed expensive, and the Jurassic Park Rapids Adventure ride is a family favourite, but whether it is worth spending $8,900 to spend a night there may indeed be debatable. 

Realistically however, we suspect this is a listing from somewhere further south at Sentosa Cove, an exclusive community designed for high net-worth individuals. 

![Sentosa Cove](./images/sentosacove.png)

Which is a great lesson for analysing place data from Singapore. We are a very compact country, and a few decimal points' worth of difference in lat-long coordinates can indeed be the difference between a much loved amusement part ride or a high-end dwelling.

Let's filter rows for ``Price`` < 1000.
```{r}


sin_listing.clean <-sin_listing.clean %>%
              dplyr::filter(Price < 1000, !is.na(Price)) %>%
                dplyr::filter(Capacity < 9) %>%
                mutate(ln_Reviews = log(1+Reviews)) %>%
                mutate(ln_Monthly_Reviews = log(1+Monthly_Reviews))
sin_listing.clean
```

```{r}

lm0 <- lm(Price ~ Capacity, data = sin_listing.clean)
summary(lm0)
stargazer(lm0, type = "text")

ggplot(data = sin_listing.clean, aes(x = Capacity, y = Price)) + geom_point(aes(size=3)) +
scale_colour_hue(l=50) + # Use a slightly darker palette than normal
geom_smooth(method=lm,   # Add linear regression lines
           se=TRUE,    #  add shaded confidence region
           fullrange=TRUE) +
theme(axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), 
        axis.title=element_text(size=15,face="bold"))
# vif(lm0)
```
```{r}

# The moderating effect of type of room. Lets model that.

lm1 <- lm(Price ~ Private_ind + House_ind, data = sin_listing.clean)
summary(lm1)
stargazer(lm1, type = "text")
```
```{r}
#Regression with Capacity and Dummy Variables for type of room:

lm2 <- lm(Price ~ Capacity + Private_ind + House_ind, data = sin_listing.clean)
summary(lm2)
stargazer(lm2, type = "text")
```

### 
```{r}
#Regression with Capacity,Dummy Variables and interaction between the two:
lm3 <- lm(Price ~ Capacity+Private_ind + House_ind+P_Cap+H_Cap, data = sin_listing.clean)
summary(lm3)
stargazer(lm3,type = "text")

```

### 2.4 Correlation Matrix
Let's find a correlation matrix for the various variables.

```{r}
sin_listing.clean_cap = select(sin_listing.clean, Price, Capacity, Private_ind, House_ind, P_Cap, H_Cap)
sin_listing.clean_cap
chart.Correlation(sin_listing.clean_cap, histogram=TRUE, pch=19)

sin_listing.clean_corr <- cor(sin_listing.clean_cap, use = "complete.obs")
head(round(sin_listing.clean_corr, 2))
corrplot(sin_listing.clean_corr)
```
```{r}
# la_listing <- la_listing %>%
#               dplyr::filter(Price < 5000 , !is.na(Beds), !is.na(Baths), !is.na(Price), !is.na(Rating)) %>%
#                 dplyr::filter(Capacity < 9) %>%
#                 mutate(ln_Reviews = log(1+Reviews)) %>%
#                 mutate(ln_Monthly_Reviews = log(1+Monthly_Reviews))

```
```{r}

# Remove Baths as Columns are all NA
# Remove ln_Price, Latitude/Longitude
sin_listing.clean_subset <- sin_listing.clean[,!names(sin_listing.clean) %in% c('ln_Price','Baths','Baths_Sqr','ln_Baths','latitude','longitude')]


# Imputing Missing Data
md.pattern(sin_listing.clean_subset)
imputed_Data <- mice(sin_listing.clean_subset, m=5, maxit = 50, method = 'pmm', seed = 100)
sin_listing.clean_imputed <- complete(imputed_Data,2)
md.pattern(sin_listing.clean_imputed)

#Define Smallest and Full Model 
minmod = lm(Price~1, data = sin_listing.clean_imputed)
fullmod = lm(Price~. , data = sin_listing.clean_imputed)

#Define Smallest and Full Model - Without Neighbourhood
#minmod = lm(Price~1, data = sin_listing.clean_imputed[,!names(sin_listing.clean_imputed) %in% c('Neighbourhood')])
#fullmod = lm(Price~. , data = sin_listing.clean_imputed[,!names(sin_listing.clean_imputed) %in% c('Neighbourhood')])


# Using BIC: k=log(nobs(fullmod), Using AIC: k=2
backward_regression = step(fullmod, scope = list(lower = minmod, upper = fullmod),direction = "backward", k=log(nobs(fullmod)), trace=F)
forward_regression = step(minmod, scope = list(lower = minmod, upper = fullmod),direction = "forward", k=log(nobs(fullmod)), trace=F)
summary(backward_regression)
summary(forward_regression)
```
